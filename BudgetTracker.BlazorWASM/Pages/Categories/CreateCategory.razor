@page "/categories/create"
@using BudgetTracker.Shared.DTOs
@using BudgetTracker.BlazorWASM.Services
@inject ICategoryService CategoryService
@inject NavigationManager Navigation
@inject Blazored.Toast.Services.IToastService ToastService
@inject ILogger<CreateCategory> Logger

<div class="page-container">
    <div class="form-card">
        <div class="form-header bg-primary text-white">
            <h3>Nowa Kategoria</h3>
            <p>Zdefiniuj własną grupę wydatków</p>
        </div>

        <div class="form-body">
            <EditForm Model="model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <div class="preview-section mb-4">
                    <label class="d-block text-muted mb-2">Podgląd na liście:</label>
                    <div class="category-badge-preview" style="background-color: @model.ColorHex">
                        <span class="badge-text">
                            @(string.IsNullOrWhiteSpace(model.Name) ? "Nazwa Kategorii" : model.Name)
                        </span>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label>Nazwa</label>
                    <InputText @bind-Value="model.Name" class="form-control" placeholder="np. Rozrywka, Paliwo" />
                    <ValidationMessage For="@(() => model.Name)" />
                </div>

                <div class="form-group mb-4">
                    <label>Kolor znacznika</label>
                    <div class="color-picker-wrapper">
                        <input type="color" class="form-control form-control-color"
                               @bind="model.ColorHex"
                               @bind:event="oninput" /> <span class="text-muted ms-2">Wybrany kod: @model.ColorHex</span>
                    </div>
                    <ValidationMessage For="@(() => model.ColorHex)" />
                </div>

                <div class="d-flex justify-content-between align-items-center mt-5">
                    <a href="categories" class="btn btn-link text-muted">Anuluj</a>
                    <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span>Zapisywanie...</span>
                        }
                        else
                        {
                            <span>Utwórz kategorię</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    // Domyślny kolor na start
    private CreateCategoryDto model = new() { ColorHex = "#3b82f6" };
    private bool isSubmitting = false;

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        try
        {
            Logger.LogInformation("Tworzenie kategorii: {Name} ({Color})", model.Name, model.ColorHex);

            await CategoryService.CreateCategoryAsync(model);

            ToastService.ShowSuccess($"Kategoria '{model.Name}' została utworzona!");

            Navigation.NavigateTo("/categories");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Błąd tworzenia kategorii");
            ToastService.ShowError("Nie udało się utworzyć kategorii.");
        }
        finally
        {
            isSubmitting = false;
        }
    }
}